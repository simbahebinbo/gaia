"use strict";(self.webpackChunkcosmos_hub_docs_site=self.webpackChunkcosmos_hub_docs_site||[]).push([[466],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||i;return n?a.createElement(h,l(l({ref:t},u),{},{components:n})):a.createElement(h,l({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[c]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3429:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const i={title:"Contributing Guidelines",order:1},l=void 0,o={unversionedId:"guidelines/code-guidelines",id:"guidelines/code-guidelines",title:"Contributing Guidelines",description:"If you want to contribute to a project and improve it, your help is welcome. We want to make Gaia as good as it can be. Contributing is also a great way to learn more about blockchain technology and improve it. Please read this document and follow our guidelines to make the process as smooth as possible. We are happy to review your code but please ensure that you have a reasonable and clean pull request.",source:"@site/docs/guidelines/code-guidelines.md",sourceDirName:"guidelines",slug:"/guidelines/code-guidelines",permalink:"/guidelines/code-guidelines",draft:!1,tags:[],version:"current",frontMatter:{title:"Contributing Guidelines",order:1},sidebar:"tutorialSidebar",previous:{title:"Gaia Fee and Fees Checks",permalink:"/modules/globalfee"},next:{title:"Interchain Security",permalink:"/interchain-security/"}},s={},p=[{value:"Maintainability",id:"maintainability",level:2},{value:"Run tests",id:"run-tests",level:2},{value:"Guidelines",id:"guidelines",level:2},{value:"Project organization",id:"project-organization",level:2},{value:"How to test this project locally",id:"how-to-test-this-project-locally",level:2},{value:"Unit Tests",id:"unit-tests",level:3},{value:"End-to-End Tests",id:"end-to-end-tests",level:3},{value:"Upgrade Test",id:"upgrade-test",level:3},{value:"Build current version and move into ./build:",id:"build-current-version-and-move-into-build",level:4},{value:"Build gaia v9.0.0 and move into ./build:",id:"build-gaia-v900-and-move-into-build",level:4},{value:"Go back to your previous working branch",id:"go-back-to-your-previous-working-branch",level:4},{value:"Install cosmovisor",id:"install-cosmovisor",level:4},{value:"Run the Chain",id:"run-the-chain",level:4},{value:"Run the upgrade",id:"run-the-upgrade",level:4},{value:"Monitor for success",id:"monitor-for-success",level:4},{value:"Guidelines",id:"guidelines-1",level:2},{value:"Line Length",id:"line-length",level:3},{value:"Doc Comments",id:"doc-comments",level:3},{value:"Declaring Empty Slices",id:"declaring-empty-slices",level:3},{value:"Indent Error Flow",id:"indent-error-flow",level:3},{value:"Unnecessary Else",id:"unnecessary-else",level:3},{value:"Named Result Parameters",id:"named-result-parameters",level:3},{value:"Package Comments",id:"package-comments",level:3},{value:"Package Names",id:"package-names",level:3},{value:"Function Names",id:"function-names",level:3},{value:"Pointers",id:"pointers",level:2},{value:"Receiver Names",id:"receiver-names",level:3},{value:"Variable Names",id:"variable-names",level:3},{value:"Zero-value Mutexes",id:"zero-value-mutexes",level:3},{value:"Copy Slices and Maps at Boundaries",id:"copy-slices-and-maps-at-boundaries",level:3},{value:"Receiving Slices and Maps",id:"receiving-slices-and-maps",level:4},{value:"Returning Slices and Maps",id:"returning-slices-and-maps",level:4},{value:"Errors",id:"errors",level:3},{value:"Error Types",id:"error-types",level:4},{value:"Error Wrapping",id:"error-wrapping",level:4},{value:"Error Naming",id:"error-naming",level:4},{value:"Handle Type Assertion Failures",id:"handle-type-assertion-failures",level:3},{value:"Avoid Embedding Types in Public Structs",id:"avoid-embedding-types-in-public-structs",level:3},{value:"Avoid <code>init()</code>",id:"avoid-init",level:3},{value:"Performance",id:"performance",level:2},{value:"Prefer strconv over fmt",id:"prefer-strconv-over-fmt",level:4},{value:"Avoid string-to-byte conversion",id:"avoid-string-to-byte-conversion",level:4},{value:"Prefer Specifying Container Capacity",id:"prefer-specifying-container-capacity",level:4},{value:"Specifying Map Capacity Hints",id:"specifying-map-capacity-hints",level:5},{value:"Specifying Slice Capacity",id:"specifying-slice-capacity",level:5},{value:"Function Grouping and Ordering",id:"function-grouping-and-ordering",level:3},{value:"Reduce Nesting",id:"reduce-nesting",level:3},{value:"Writing Tests",id:"writing-tests",level:3},{value:"Use Subtests",id:"use-subtests",level:4},{value:"Avoid writing directly in the stdout",id:"avoid-writing-directly-in-the-stdout",level:3},{value:"Avoid panic",id:"avoid-panic",level:3}],u={toc:p},c="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"If you want to contribute to a project and improve it, your help is welcome. We want to make Gaia as good as it can be. Contributing is also a great way to learn more about blockchain technology and improve it. Please read this document and follow our guidelines to make the process as smooth as possible. We are happy to review your code but please ensure that you have a reasonable and clean pull request."),(0,r.kt)("p",null,"This documents idiomatic conventions in the Go code that we follow for gaia development. A lot of these are general guidelines for Go, while others extend upon external resources:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://golang.org/doc/effective_go.html"},"Effective Go")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/golang/go/wiki/CommonMistakes"},"Go Common Mistakes")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/golang/go/wiki/CodeReviewComments"},"Go Code Review Comments"))),(0,r.kt)("h2",{id:"maintainability"},"Maintainability"),(0,r.kt)("p",null,"From a maintainance, performance and security perspective, it is important to keep the footprint of the ",(0,r.kt)("inlineCode",{parentName:"p"},"gaiad")," application as lean as possible."),(0,r.kt)("p",null,"When adding any new feature, you must ensure that any libraries you wish to include are well maintained and have sufficient usage in the wider ecosystem. This is necessary to avoid having to rework the ",(0,r.kt)("inlineCode",{parentName:"p"},"gaiad")," application at a later date, if a library is no longer maintained or is abandoned by its core contributors."),(0,r.kt)("p",null,"In addition to the above, if any library is to be included, it is necessary to check that the version used does not have any known vunerabilities. As a developer working on a feature, before making a pull request, ensure that you run, along with the testing targets, the vulnerability checking target in the root of the gaia repository directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"make govulncheck\n")),(0,r.kt)("p",null,"The above command will run the vulnerability checker that will detail any known issues for the library version that your using. If any issues are raised, or you have any concerns, please reach out to the core-developers who will be able to advise further."),(0,r.kt)("h2",{id:"run-tests"},"Run tests"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run unit tests")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"make test-unit\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the unit tests and output the coverage file (coverage.txt).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"make test-unit-cover\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the unit tests with the race condition flag on.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"make test-race\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run end-to-end integration tests (Docker needed).")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"make docker-build-hermes && \\\nmake docker-build-debug && \\\nmake test-e2e\n")),(0,r.kt)("h2",{id:"guidelines"},"Guidelines"),(0,r.kt)("p",null,"These guidelines are the conventions that govern our code. These conventions cover far more than just source file formatting. Can ",(0,r.kt)("inlineCode",{parentName:"p"},"gofmt")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"goimports")," handle that for us."),(0,r.kt)("p",null,"The goal of this guide is to manage this complexity by describing in detail the Dos and Don'ts of writing Go code. These rules keep the code base manageable while allowing engineers to use Go language features productively."),(0,r.kt)("p",null,"Try to avoid extensive methods and always test your code. All PRs should have at least 95% of code coverage."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#contributing"},"Contributing"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#maintainability"},"Maintainability")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#run-tests"},"Run tests")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#guidelines"},"Guidelines")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#project-organization"},"Project organization")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#how-to-test-this-project-locally"},"How to test this project locally"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#unit-tests"},"Unit Tests")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#end-to-end-tests"},"End-to-End Tests")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#upgrade-test"},"Upgrade Test"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#build-current-version-and-move-into-build"},"Build current version and move into ./build:")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#build-gaia-v900-and-move-into-build"},"Build gaia v9.0.0 and move into ./build:")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#go-back-to-your-previous-working-branch"},"Go back to your previous working branch")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#install-cosmovisor"},"Install cosmovisor")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#run-the-chain"},"Run the Chain")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#run-the-upgrade"},"Run the upgrade")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#monitor-for-success"},"Monitor for success")))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#guidelines-1"},"Guidelines"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#line-length"},"Line Length")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#doc-comments"},"Doc Comments")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#declaring-empty-slices"},"Declaring Empty Slices")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#indent-error-flow"},"Indent Error Flow")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#unnecessary-else"},"Unnecessary Else")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#named-result-parameters"},"Named Result Parameters")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#package-comments"},"Package Comments")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#package-names"},"Package Names")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#function-names"},"Function Names")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#pointers"},"Pointers"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#receiver-names"},"Receiver Names")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#variable-names"},"Variable Names")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#zero-value-mutexes"},"Zero-value Mutexes")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#copy-slices-and-maps-at-boundaries"},"Copy Slices and Maps at Boundaries"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#receiving-slices-and-maps"},"Receiving Slices and Maps")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#returning-slices-and-maps"},"Returning Slices and Maps")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#errors"},"Errors"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#error-types"},"Error Types")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#error-wrapping"},"Error Wrapping")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#error-naming"},"Error Naming")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#handle-type-assertion-failures"},"Handle Type Assertion Failures")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#avoid-embedding-types-in-public-structs"},"Avoid Embedding Types in Public Structs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#avoid-init"},"Avoid ",(0,r.kt)("inlineCode",{parentName:"a"},"init()"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#performance"},"Performance"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#prefer-strconv-over-fmt"},"Prefer strconv over fmt")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#avoid-string-to-byte-conversion"},"Avoid string-to-byte conversion")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#prefer-specifying-container-capacity"},"Prefer Specifying Container Capacity"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#specifying-map-capacity-hints"},"Specifying Map Capacity Hints")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#specifying-slice-capacity"},"Specifying Slice Capacity")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#function-grouping-and-ordering"},"Function Grouping and Ordering")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#reduce-nesting"},"Reduce Nesting")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#writing-tests"},"Writing Tests"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#use-subtests"},"Use Subtests")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#avoid-writing-directly-in-the-stdout"},"Avoid writing directly in the stdout")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#avoid-panic"},"Avoid panic"))))))),(0,r.kt)("h2",{id:"project-organization"},"Project organization"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/ante: Where the ante-handler logic is defined.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/app: Where the application is defined.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/client: OpenAPI/Swagger specs, JSON schema files, protocol definition files."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"/swagger-ui"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/cmd/gaiad: Main applications for this project."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"cmd/"),(0,r.kt)("li",{parentName:"ul"},"main.go"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/contrib (scripts): Scripts to perform various build, install, analysis, etc operations."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"/devtools"),(0,r.kt)("li",{parentName:"ul"},"/generate_release_note"),(0,r.kt)("li",{parentName:"ul"},"/githooks"),(0,r.kt)("li",{parentName:"ul"},"/scripts"),(0,r.kt)("li",{parentName:"ul"},"/testnets"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/docs: Gaia docs.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/pkg: Library code that's to be reusable."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"/address"),(0,r.kt)("li",{parentName:"ul"},"/genesis"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/proto: Proto type definitions")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/tests/e2e: Additional external test apps and test data.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/third_party/proto: External proto type definitions")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/tools: Supporting tools for this project.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"/x: Cosmos Modules."))),(0,r.kt)("h2",{id:"how-to-test-this-project-locally"},"How to test this project locally"),(0,r.kt)("h3",{id:"unit-tests"},"Unit Tests"),(0,r.kt)("p",null,"Running unit tests locally should ensure that the tests inside of ",(0,r.kt)("inlineCode",{parentName:"p"},"/tests/e2e")," are not run. These tests require active running docker containers."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"make test-unit\n")),(0,r.kt)("h3",{id:"end-to-end-tests"},"End-to-End Tests"),(0,r.kt)("p",null,"To run the E2E tests you need to have an instance of Docker running. Then make sure you have the most recent version of the code built in the containers by running:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"make docker-build-debug\n")),(0,r.kt)("p",null,"Then run the tests:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"make test-e2e\n")),(0,r.kt)("h3",{id:"upgrade-test"},"Upgrade Test"),(0,r.kt)("p",null,"Instructions for running the upgrade test locally"),(0,r.kt)("h4",{id:"build-current-version-and-move-into-build"},"Build current version and move into ./build:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"git checkout v8.0.0\nmake build \ncp ./build/gaiad ./build/gaiad8\n")),(0,r.kt)("h4",{id:"build-gaia-v900-and-move-into-build"},"Build gaia v9.0.0 and move into ./build:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"git checkout v9.0.0\nmake build \ncp ./build/gaiad ./build/gaiad9\n")),(0,r.kt)("h4",{id:"go-back-to-your-previous-working-branch"},"Go back to your previous working branch"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"git checkout -\n")),(0,r.kt)("h4",{id:"install-cosmovisor"},"Install cosmovisor"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"go install github.com/cosmos/cosmos-sdk/cosmovisor/cmd/cosmovisor@v1.3.0\n")),(0,r.kt)("h4",{id:"run-the-chain"},"Run the Chain"),(0,r.kt)("p",null,"This script prepares the chain and starts it using cosmovisor"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"./contrib/scripts/run-gaia-v8.sh\n")),(0,r.kt)("h4",{id:"run-the-upgrade"},"Run the upgrade"),(0,r.kt)("p",null,"In another terminal window, run the script that waits 10 seconds for gaia to start then makes gov proposal to perform an upgrade at height 15"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"./contrib/scripts/run-upgrade-commands.sh 15\n")),(0,r.kt)("h4",{id:"monitor-for-success"},"Monitor for success"),(0,r.kt)("p",null,"In a third window run the upgrade monitoring script that will exit without error when the upgrade succeeds."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"./contrib/scripts/test_upgrade.sh 20 5 16 localhost\n")),(0,r.kt)("p",null,"This should show logs that demonstrate a successful upgrade by reaching block height 16."),(0,r.kt)("h2",{id:"guidelines-1"},"Guidelines"),(0,r.kt)("h3",{id:"line-length"},"Line Length"),(0,r.kt)("p",null,"Avoid uncomfortably long lines. Similarly, don't add line breaks to keep lines short when they are more readable long--for example if they are repetitive. The maximum line length is 120. If your line is over 120 characters, break it;"),(0,r.kt)("h3",{id:"doc-comments"},"Doc Comments"),(0,r.kt)("p",null,"All top-level, exported names should have doc comments, as should non-trivial unexported type or function declarations. See ",(0,r.kt)("a",{parentName:"p",href:"https://go.dev/doc/effective_go#commentary"},"https://go.dev/doc/effective_go#commentary")," for more information about commentary conventions."),(0,r.kt)("h3",{id:"declaring-empty-slices"},"Declaring Empty Slices"),(0,r.kt)("p",null,"When declaring an empty slice, prefer"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"var t []string\n")),(0,r.kt)("p",null,"over"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"t := []string{}\n")),(0,r.kt)("p",null,"The former declares a nil slice value, while the latter is non-nil but zero-length. They are functionally equivalent\u2014their ",(0,r.kt)("inlineCode",{parentName:"p"},"len")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"cap")," are both zero\u2014but the nil slice is the preferred style."),(0,r.kt)("p",null,"Note that there are limited circumstances where a non-nil but the zero-length slice is preferred, such as when encoding JSON objects (a ",(0,r.kt)("inlineCode",{parentName:"p"},"nil")," slice encodes to ",(0,r.kt)("inlineCode",{parentName:"p"},"null"),", while ",(0,r.kt)("inlineCode",{parentName:"p"},"[]string{}")," encodes to the JSON array ",(0,r.kt)("inlineCode",{parentName:"p"},"[]"),")."),(0,r.kt)("p",null,"When designing interfaces, avoid distinguishing between a nil slice and a non-nil, zero-length slice, as this can lead to subtle programming errors. It's also important to distinguish if a map key exists from whether its value is ",(0,r.kt)("inlineCode",{parentName:"p"},"zero"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"nil"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"false"),"."),(0,r.kt)("p",null,"For more discussion about nil in Go see Francesc Campoy's talk ",(0,r.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=ynoY2xz-F8s"},"Understanding Nil"),"."),(0,r.kt)("h3",{id:"indent-error-flow"},"Indent Error Flow"),(0,r.kt)("p",null,"Try to keep the normal code path at a minimal indentation and indent the error handling, dealing with it first. This improves the readability of the code by permitting visual scanning of the normal path quickly. For instance, don't write:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"if err != nil {\n    // error handling\n} else {\n    // normal code\n}\n")),(0,r.kt)("p",null,"Instead, write:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"if err != nil {\n    // error handling\n    return // or continue, etc.\n}\n// normal code\n")),(0,r.kt)("h3",{id:"unnecessary-else"},"Unnecessary Else"),(0,r.kt)("p",null,"If a variable is set in both branches of an if, it can be replaced with a single if."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"var a int\nif b {\n  a = 100\n} else {\n  a = 10\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"a := 10\nif b {\n  a = 100\n}\n")),(0,r.kt)("h3",{id:"named-result-parameters"},"Named Result Parameters"),(0,r.kt)("p",null,"Consider what it will look like in godoc. Named result parameters like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (n *Node) Parent1() (node *Node) {}\nfunc (n *Node) Parent2() (node *Node, err error) {}\n")),(0,r.kt)("p",null,"It will be repetitive in godoc; better to use:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (n *Node) Parent1() *Node {}\nfunc (n *Node) Parent2() (*Node, error) {}\n")),(0,r.kt)("p",null,"On the other hand, adding names may be helpful in some contexts if a function returns two or three parameters of the same type or if the meaning of a result isn't clear from the context. Don't name result parameters just to avoid declaring a var inside the function; that trades off minor implementation brevity at the cost of unnecessary API verbosity."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (f *Foo) Location() (float64, float64, error)\n")),(0,r.kt)("p",null,"It is less clear than the:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// Location returns f's latitude and longitude.\n// Negative values mean south and west, respectively.\nfunc (f *Foo) Location() (lat, long float64, err error)\n")),(0,r.kt)("p",null,"Naked returns are okay if the function is a handful of lines. Once it's a medium-sized function, be explicit with your return values. Corollary: it's not worth naming result parameters just because it enables you to use naked returns. Clarifying docs is always more important than saving a line or two in your function."),(0,r.kt)("p",null,"Finally, it would help if you named a result parameter in some cases to change it in a deferred closure. That is always OK."),(0,r.kt)("h3",{id:"package-comments"},"Package Comments"),(0,r.kt)("p",null,"Package comments, like all comments to be presented by godoc, must appear adjacent to the package clause with no blank line."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"/*\nPackage template implements data-driven templates for generating textual\noutput such as HTML.\n....\n*/\npackage template\n")),(0,r.kt)("p",null,'For "package main" comments, other styles of comment are fine after the binary name (and it may be capitalized if it comes first). For example, for a ',(0,r.kt)("inlineCode",{parentName:"p"},"package main")," in the directory ",(0,r.kt)("inlineCode",{parentName:"p"},"seedgen")," you could write:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// Seedgen ..\npackage main\n")),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"https://go.dev/doc/effective_go#commentary"},"https://go.dev/doc/effective_go#commentary")," for more information about commentary conventions."),(0,r.kt)("h3",{id:"package-names"},"Package Names"),(0,r.kt)("p",null,"All references to names in your package will be done using the package name so that you can omit that name from the identifiers. For example, if you are in package chubby, you don't need to type ChubbyFile, which clients will write as ",(0,r.kt)("inlineCode",{parentName:"p"},"chubby.ChubbyFile"),". Instead, name the type ",(0,r.kt)("inlineCode",{parentName:"p"},"File"),", which clients will write as ",(0,r.kt)("inlineCode",{parentName:"p"},"chubby.File"),". Avoid meaningless package names like util, common, misc, API, types, and interfaces. See ",(0,r.kt)("a",{parentName:"p",href:"https://go.dev/doc/effective_go#package-names"},"https://go.dev/doc/effective_go#package-names")," and ",(0,r.kt)("a",{parentName:"p",href:"https://go.dev/blog/package-names"},"https://go.dev/blog/package-names")," for more."),(0,r.kt)("p",null,"When naming packages, choose a name that is:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"All lowercase. No capitals or underscores."),(0,r.kt)("li",{parentName:"ul"},"Does not need to be renamed using named imports at most call sites."),(0,r.kt)("li",{parentName:"ul"},"Short and succinct. Remember that the name is identified in full at every call site."),(0,r.kt)("li",{parentName:"ul"},"Not plural. For example, ",(0,r.kt)("inlineCode",{parentName:"li"},"net/url"),", not ",(0,r.kt)("inlineCode",{parentName:"li"},"net/urls"),"."),(0,r.kt)("li",{parentName:"ul"},"Not ",(0,r.kt)("inlineCode",{parentName:"li"},"common"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"util"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"shared"),", or ",(0,r.kt)("inlineCode",{parentName:"li"},"lib"),". These are bad, uninformative names."),(0,r.kt)("li",{parentName:"ul"},"To distinguish SDK and Gaia with the same package name, add SDK or Gaia or the module name as the prefix. E.g.: ",(0,r.kt)("inlineCode",{parentName:"li"},"sdk/types"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"gaia/types")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"gaia/x/globalfee/types"),", can use ",(0,r.kt)("inlineCode",{parentName:"li"},"sdktype"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"gaiatype"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"globalfeetype"),".")),(0,r.kt)("p",null,"See also ",(0,r.kt)("a",{parentName:"p",href:"https://blog.golang.org/package-names"},"Package Names")," and ",(0,r.kt)("a",{parentName:"p",href:"https://rakyll.org/style-packages/"},"Style guideline for Go packages"),"."),(0,r.kt)("h3",{id:"function-names"},"Function Names"),(0,r.kt)("p",null,"We follow the Go community's convention of using ",(0,r.kt)("a",{parentName:"p",href:"https://golang.org/doc/effective_go.html#mixed-caps"},"MixedCaps for function names"),". An exception is made for test functions, which may contain underscores\nfor grouping related test cases, e.g., ",(0,r.kt)("inlineCode",{parentName:"p"},"TestMyFunction_WhatIsBeingTested"),"."),(0,r.kt)("h2",{id:"pointers"},"Pointers"),(0,r.kt)("p",null,"Try to avoid pointers if you don't need them. Don't pass pointers as function arguments to save a few bytes. If a function refers to its argument ",(0,r.kt)("inlineCode",{parentName:"p"},"x")," only as ",(0,r.kt)("inlineCode",{parentName:"p"},"*x")," throughout, then the argument shouldn't be a pointer. Common instances of this include passing a pointer to a string (",(0,r.kt)("inlineCode",{parentName:"p"},"*string"),") or a pointer to an interface value (",(0,r.kt)("inlineCode",{parentName:"p"},"*io.Reader"),"). In both cases, the value itself is a fixed size and can be passed directly. This advice does not apply to large structs or even small structs that might grow."),(0,r.kt)("p",null,"Choosing whether to use a value or pointer receiver on methods can be difficult, especially for new Go programmers. If in doubt, use a pointer, but there are times when a value receiver makes sense, usually for reasons of efficiency, such as for small unchanging structs or values of basic type. Some useful guidelines:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If the receiver is a map, func, or chan, don't use a pointer to them. If the receiver is a slice and the method doesn't reslice or reallocate the slice, don't use a pointer."),(0,r.kt)("li",{parentName:"ul"},"If the method needs to mutate the receiver, the receiver must be a pointer."),(0,r.kt)("li",{parentName:"ul"},"If the receiver is a struct that contains a sync.Mutex or similar synchronizing field, the receiver must be a pointer to avoid copying."),(0,r.kt)("li",{parentName:"ul"},"A pointer receiver is more efficient if the receiver is a large struct or array. How large is large? Assume it's equivalent to passing all its elements as arguments to the method. If that feels too large, it's also too large for the receiver."),(0,r.kt)("li",{parentName:"ul"},"Can functions or methods, either concurrently or when called from this method, mutate the receiver? A value type creates a copy of the receiver when the method is invoked, so outside updates will not be applied to this receiver. If changes must be visible in the original receiver, the receiver must be a pointer."),(0,r.kt)("li",{parentName:"ul"},"If the receiver is a struct, array, or slice and any of its elements is a pointer to something that might be mutating, prefer a pointer receiver, as it will make the intention clearer to the reader."),(0,r.kt)("li",{parentName:"ul"},"If the receiver is a small array or struct that is naturally a value type (for instance, something like the ",(0,r.kt)("inlineCode",{parentName:"li"},"time.Time")," type), with no mutable fields and no pointers, or is just a simple basic type such as int or string, a value receiver makes sense. A value receiver can reduce the amount of garbage generated; if a value is passed to a value method, an on-stack copy can be used instead of allocating it to the heap. (The compiler tries to be smart about avoiding this allocation, but it can't always succeed.) Don't choose a value receiver type for this reason without profiling first."),(0,r.kt)("li",{parentName:"ul"},"Don't mix receiver types. Choose either pointers or struct types for all available methods."),(0,r.kt)("li",{parentName:"ul"},"Finally, when in doubt, use a pointer receiver.")),(0,r.kt)("h3",{id:"receiver-names"},"Receiver Names"),(0,r.kt)("p",null,'The name of a method\'s receiver should be a reflection of its identity; often, a one or two-letter abbreviation of its type suffices (such as "c" or "cl" for "Client"). Don\'t use generic names such as "me", "this", or "self", identifiers typical of object-oriented languages that give the method a special meaning. In Go, the receiver of a method is just another parameter and, therefore, should be named accordingly. The name need not be as descriptive as that of a method argument, as its role is evident and serves no documentary purpose. It can be very short as it will appear on almost every line of every type of method; familiarity admits brevity. Be consistent, too: if you call the receiver "c" in one method, don\'t call it "cl" in another.'),(0,r.kt)("p",null,"eg:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (s *IntegrationTestSuite) TestDecode()\n")),(0,r.kt)("h3",{id:"variable-names"},"Variable Names"),(0,r.kt)("p",null,"Variable names in Go should be short rather than long. This is especially true for local variables with limited scope. Prefer ",(0,r.kt)("inlineCode",{parentName:"p"},"c")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"lineCount"),".  Prefer ",(0,r.kt)("inlineCode",{parentName:"p"},"i")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"sliceIndex"),"."),(0,r.kt)("p",null,"The basic rule: the further from its declaration that a name is used, the more descriptive the name must be. For a method receiver, one or two letters are sufficient. Common variables such as loop indices and readers can be a single letter (",(0,r.kt)("inlineCode",{parentName:"p"},"i', "),"r`). More unusual things and global variables need more descriptive names."),(0,r.kt)("h3",{id:"zero-value-mutexes"},"Zero-value Mutexes"),(0,r.kt)("p",null,"The zero-value of ",(0,r.kt)("inlineCode",{parentName:"p"},"sync.Mutex")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"sync.RWMutex")," is valid, so you rarely need a pointer to a mutex."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"mu := new(sync.Mutex)\nmu.Lock()\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"var mu sync.Mutex\nmu.Lock()\n")),(0,r.kt)("p",null,"If you use a struct by pointer, then the mutex should be a non-pointer field. Do not embed the mutex on the struct, even if the struct is not exported."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type SMap struct {\n  sync.Mutex\n\n  data map[string]string\n}\n\nfunc (m *SMap) Get(k string) string {\n  m.Lock()\n  defer m.Unlock()\n\n  return m.data[k]\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Mutex")," field and the ",(0,r.kt)("inlineCode",{parentName:"p"},"Lock")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Unlock")," methods are unintentionally part of the exported API of ",(0,r.kt)("inlineCode",{parentName:"p"},"SMap"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type SMap struct {\n  mu sync.Mutex\n\n  data map[string]string\n}\n\nfunc (m *SMap) Get(k string) string {\n  m.mu.Lock()\n  defer m.mu.Unlock()\n\n  return m.data[k]\n}\n")),(0,r.kt)("h3",{id:"copy-slices-and-maps-at-boundaries"},"Copy Slices and Maps at Boundaries"),(0,r.kt)("p",null,"Slices and maps contain pointers to the underlying data, so be wary of scenarios when they need to be copied."),(0,r.kt)("h4",{id:"receiving-slices-and-maps"},"Receiving Slices and Maps"),(0,r.kt)("p",null,"Remember that users can modify a map or slice you received as an argument if you store a reference to it."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (d *Driver) SetTrips(trips []Trip) {\n  d.trips = trips\n}\n\ntrips := ...\nd1.SetTrips(trips)\n\n// Did you mean to modify d1.trips?\ntrips[0] = ...\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (d *Driver) SetTrips(trips []Trip) {\n  d.trips = make([]Trip, len(trips))\n  copy(d.trips, trips)\n}\n\ntrips := ...\nd1.SetTrips(trips)\n\n// We can now modify trips[0] without affecting d1.trips.\ntrips[0] = ...\n")),(0,r.kt)("h4",{id:"returning-slices-and-maps"},"Returning Slices and Maps"),(0,r.kt)("p",null,"Similarly, be wary of user modifications to maps or slices exposing the internal state."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type Stats struct {\n  mu sync.Mutex\n  counters map[string]int\n}\n\n// Snapshot returns the current stats.\nfunc (s *Stats) Snapshot() map[string]int {\n  s.mu.Lock()\n  defer s.mu.Unlock()\n\n  return s.counters\n}\n\n// snapshot is no longer protected by the mutex, so any\n// access to the snapshot is subject to data races.\nsnapshot := stats.Snapshot()\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type Stats struct {\n  mu sync.Mutex\n  counters map[string]int\n}\n\nfunc (s *Stats) Snapshot() map[string]int {\n  s.mu.Lock()\n  defer s.mu.Unlock()\n\n  result := make(map[string]int, len(s.counters))\n  for k, v := range s.counters {\n    result[k] = v\n  }\n  return result\n}\n\n// Snapshot is now a copy.\nsnapshot := stats.Snapshot()\n")),(0,r.kt)("h3",{id:"errors"},"Errors"),(0,r.kt)("h4",{id:"error-types"},"Error Types"),(0,r.kt)("p",null,"There are a few options for declaring errors. Consider the following before picking the option best suited for your use case."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Does the caller need to match the error to handle it? If yes, we must support the ",(0,r.kt)("a",{parentName:"li",href:"https://golang.org/pkg/errors/#Is"},(0,r.kt)("inlineCode",{parentName:"a"},"errors.Is"))," or ",(0,r.kt)("a",{parentName:"li",href:"https://golang.org/pkg/errors/#As"},(0,r.kt)("inlineCode",{parentName:"a"},"errors.As"))," functions by declaring a top-level error variable or a custom type."),(0,r.kt)("li",{parentName:"ul"},"Is the error message a static string, or is it a dynamic string that requires contextual information? We can use ",(0,r.kt)("a",{parentName:"li",href:"https://golang.org/pkg/errors/#New"},(0,r.kt)("inlineCode",{parentName:"a"},"errors.New")),", but for the latter, we must use ",(0,r.kt)("a",{parentName:"li",href:"https://golang.org/pkg/fmt/#Errorf"},(0,r.kt)("inlineCode",{parentName:"a"},"fmt.Errorf"))," or a custom error type."),(0,r.kt)("li",{parentName:"ul"},"Are we propagating a new error returned by a downstream function? See the ",(0,r.kt)("a",{parentName:"li",href:"#error-wrapping"},"section on error wrapping"),".")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Error matching?"),(0,r.kt)("th",{parentName:"tr",align:null},"Error Message"),(0,r.kt)("th",{parentName:"tr",align:null},"Guidance"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"static"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://golang.org/pkg/errors/#New"},(0,r.kt)("inlineCode",{parentName:"a"},"errors.New")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"dynamic"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://golang.org/pkg/fmt/#Errorf"},(0,r.kt)("inlineCode",{parentName:"a"},"fmt.Errorf")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"static"),(0,r.kt)("td",{parentName:"tr",align:null},"top-level ",(0,r.kt)("inlineCode",{parentName:"td"},"var")," with ",(0,r.kt)("a",{parentName:"td",href:"https://golang.org/pkg/errors/#New"},(0,r.kt)("inlineCode",{parentName:"a"},"errors.New")))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"dynamic"),(0,r.kt)("td",{parentName:"tr",align:null},"custom ",(0,r.kt)("inlineCode",{parentName:"td"},"error")," type")))),(0,r.kt)("p",null,"For example, use ",(0,r.kt)("a",{parentName:"p",href:"https://golang.org/pkg/errors/#New"},(0,r.kt)("inlineCode",{parentName:"a"},"errors.New"))," for an error with a static string. Export this error as a variable to support matching it with ",(0,r.kt)("inlineCode",{parentName:"p"},"errors.Is")," if the caller needs to match and handle this error."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"No error matching:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// package foo\n\nfunc Open() error {\n  return errors.New("could not open")\n}\n\n// package bar\n\nif err := foo.Open(); err != nil {\n  //Can\'t handle the error.\n  panic("unknown error")\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Error matching")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// package foo\n\nvar ErrCouldNotOpen = errors.New("could not open")\n\nfunc Open() error {\n  return ErrCouldNotOpen\n}\n\n// package bar\n\nif err := foo.Open(); err != nil {\n  if errors.Is(err, foo.ErrCouldNotOpen) {\n    // handle the error\n  } else {\n    panic("unknown error")\n  }\n}\n')),(0,r.kt)("p",null,"For an error with a dynamic string, use ",(0,r.kt)("a",{parentName:"p",href:"https://golang.org/pkg/fmt/#Errorf"},(0,r.kt)("inlineCode",{parentName:"a"},"fmt.Errorf"))," if the caller does not need to match it and a custom ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," if the caller does need to match it."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"No error matching")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// package foo\n\nfunc Open(file string) error {\n  return fmt.Errorf("file %q not found", file)\n}\n\n// package bar\n\nif err := foo.Open("testfile.txt"); err != nil {\n  //Can\'t handle the error.\n  panic("unknown error")\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Error matching")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// package foo\n\ntype NotFoundError struct {\n  File string\n}\n\nfunc (e *NotFoundError) Error() string {\n  return fmt.Sprintf("file %q not found", e.File)\n}\n\nfunc Open(file string) error {\n  return &NotFoundError{File: file}\n}\n\n\n// package bar\n\nif err := foo.Open("testfile.txt"); err != nil {\n  var notFound *NotFoundError\n  if errors.As(err, &notFound) {\n    // handle the error\n  } else {\n    panic("unknown error")\n  }\n}\n')),(0,r.kt)("p",null,"Note that if you export error variables or types from a package, they will become part of the public API of the package."),(0,r.kt)("h4",{id:"error-wrapping"},"Error Wrapping"),(0,r.kt)("p",null,"There are three main options for propagating errors if a call fails:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"return the original error as-is"),(0,r.kt)("li",{parentName:"ul"},"add context with ",(0,r.kt)("inlineCode",{parentName:"li"},"fmt.Errorf")," and the ",(0,r.kt)("inlineCode",{parentName:"li"},"%w")," verb"),(0,r.kt)("li",{parentName:"ul"},"add context with ",(0,r.kt)("inlineCode",{parentName:"li"},"fmt.Errorf")," and the ",(0,r.kt)("inlineCode",{parentName:"li"},"%v")," verb")),(0,r.kt)("p",null,"Return the original error as-is if there is no additional context to add. This maintains the original error type and message. This is well suited for cases when the underlying error message has sufficient information to track down where it came from."),(0,r.kt)("p",null,'Otherwise, add context to the error message where possible so that instead of a vague error such as "connection refused", you get more valuable errors such as "call service foo: connection refused".'),(0,r.kt)("p",null,"Use ",(0,r.kt)("inlineCode",{parentName:"p"},"fmt.Errorf")," to add context to your errors, picking between the ",(0,r.kt)("inlineCode",{parentName:"p"},"%w")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"%v")," verbs based on whether the caller should be able to match and extract the underlying cause."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"%w")," if the caller should have access to the underlying error. This is a good default for most wrapped errors, but be aware that callers may begin to rely on this behavior. So for cases where the wrapped error is a known ",(0,r.kt)("inlineCode",{parentName:"li"},"var")," or type, document and test it as part of your function's contract."),(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"%v")," to obfuscate the underlying error. Callers will be unable to match it, but you can switch to ",(0,r.kt)("inlineCode",{parentName:"li"},"%w")," in the future if needed.")),(0,r.kt)("p",null,'When adding context to returned errors, keep the context succinct by avoiding phrases like "failed to", which state the obvious and pile up as the error percolates up through the stack:'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'s, err := store.New()\nif err != nil {\n    return fmt.Errorf(\n        "failed to create a new store: %w", err)\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"failed to x: failed to y: failed to create a new store: the error\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'s, err := store.New()\nif err != nil {\n    return fmt.Errorf(\n        "new store: %w", err)\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"x: y: new store: the error\n")),(0,r.kt)("p",null,"However, once the error is sent to another system, it should be clear that the message is an error (e.g., an ",(0,r.kt)("inlineCode",{parentName:"p"},"err"),' tag or "Failed" prefix in logs).'),(0,r.kt)("p",null,"See also ",(0,r.kt)("a",{parentName:"p",href:"https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully"},"Don't just check errors, handle them gracefully"),"."),(0,r.kt)("h4",{id:"error-naming"},"Error Naming"),(0,r.kt)("p",null,"For error values stored as global variables, use the prefix ",(0,r.kt)("inlineCode",{parentName:"p"},"Err")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"err")," depending on whether they're exported."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'var (\n  // The following two errors are exported\n  // so that users of this package can match them\n  // with errors.Is.\n\n  ErrBrokenLink = errors.New("link is broken")\n  ErrCouldNotOpen = errors.New("could not open")\n\n  // This error is not exported because\n  // we don\'t want to make it part of our public API.\n  // We may still use it inside the package\n  // with errors.Is.\n\n  errNotFound = errors.New("not found")\n)\n')),(0,r.kt)("p",null,"For custom error types, use the suffix ",(0,r.kt)("inlineCode",{parentName:"p"},"Error")," instead."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// Similarly, this error is exported\n// so that users of this package can match it\n// with errors.As.\n\ntype NotFoundError struct {\n  File string\n}\n\nfunc (e *NotFoundError) Error() string {\n  return fmt.Sprintf("file %q not found", e.File)\n}\n\n// And this error is not exported because\n// we don\'t want to make it part of the public API.\n// We can still use it inside the package\n// with errors.As.\n\ntype resolveError struct {\n  Path string\n}\n\nfunc (e *resolveError) Error() string {\n  return fmt.Sprintf("resolve %q", e.Path)\n}\n')),(0,r.kt)("h3",{id:"handle-type-assertion-failures"},"Handle Type Assertion Failures"),(0,r.kt)("p",null,"The single return value form of a ",(0,r.kt)("a",{parentName:"p",href:"https://golang.org/ref/spec#Type_assertions"},"type assertion"),' will panic on an incorrect type. Therefore, always use the "comma ok" idiom.'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"t := i.(string)\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"t, ok := i.(string)\nif !ok {\n  // handle the error gracefully\n}\n")),(0,r.kt)("h3",{id:"avoid-embedding-types-in-public-structs"},"Avoid Embedding Types in Public Structs"),(0,r.kt)("p",null,"These embedded types leak implementation details, inhibit type evolution, and obscure documentation."),(0,r.kt)("p",null,"Assuming you have implemented a variety of list types using a shared ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractList"),", avoid embedding the ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractList")," in your concrete list implementations. Instead, hand-write only the methods to your concrete list that will delegate to the abstract list."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type AbstractList struct {}\n\n// Add adds an entity to the list.\nfunc (l *AbstractList) Add(e Entity) {\n  // ...\n}\n\n// Remove removes an entity from the list.\nfunc (l *AbstractList) Remove(e Entity) {\n  // ...\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// ConcreteList is a list of entities.\ntype ConcreteList struct {\n  *AbstractList\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// ConcreteList is a list of entities.\ntype ConcreteList struct {\n  list *AbstractList\n}\n\n// Add adds an entity to the list.\nfunc (l *ConcreteList) Add(e Entity) {\n  l.list.Add(e)\n}\n\n// Remove removes an entity from the list.\nfunc (l *ConcreteList) Remove(e Entity) {\n  l.list.Remove(e)\n}\n")),(0,r.kt)("p",null,"Go allows ",(0,r.kt)("a",{parentName:"p",href:"https://golang.org/doc/effective_go.html#embedding"},"type embedding")," as a compromise between inheritance and composition. The outer type gets implicit copies of the embedded type's methods. These methods, by default, delegate to the same method of the embedded instance."),(0,r.kt)("p",null,"The struct also gains a field by the same name as the type. So, if the embedded type is public, the field is public. To maintain backward compatibility, every future version of the outer type must keep the embedded type. An embedded type is rarely necessary. It is a convenience that helps you avoid writing tedious delegate methods."),(0,r.kt)("p",null,"Even embedding a compatible AbstractList ",(0,r.kt)("em",{parentName:"p"},"interface")," instead of the struct would offer the developer more flexibility to change in the future but still leak the detail that the concrete lists use an abstract implementation."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// AbstractList is a generalized implementation\n// for various kinds of lists of entities.\ntype AbstractList interface {\n  Add(Entity)\n  Remove(Entity)\n}\n\n// ConcreteList is a list of entities.\ntype ConcreteList struct {\n  AbstractList\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// ConcreteList is a list of entities.\ntype ConcreteList struct {\n  list AbstractList\n}\n\n// Add adds an entity to the list.\nfunc (l *ConcreteList) Add(e Entity) {\n  l.list.Add(e)\n}\n\n// Remove removes an entity from the list.\nfunc (l *ConcreteList) Remove(e Entity) {\n  l.list.Remove(e)\n}\n")),(0,r.kt)("p",null,"Either with an embedded struct or an embedded interface, the embedded type places limits on the evolution of the type."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Adding methods to an embedded interface is a breaking change."),(0,r.kt)("li",{parentName:"ul"},"Removing methods from an embedded struct is a breaking change."),(0,r.kt)("li",{parentName:"ul"},"Removing the embedded type is a breaking change."),(0,r.kt)("li",{parentName:"ul"},"Replacing the embedded type, even with an alternative that satisfies the same\ninterface, is a breaking change.")),(0,r.kt)("p",null,"Although writing these delegate methods is tedious, the additional effort hides an implementation detail, leaves more opportunities for change, and eliminates indirection for discovering the whole List interface in the documentation."),(0,r.kt)("h3",{id:"avoid-init"},"Avoid ",(0,r.kt)("inlineCode",{parentName:"h3"},"init()")),(0,r.kt)("p",null,"Avoid ",(0,r.kt)("inlineCode",{parentName:"p"},"init()")," where possible. When ",(0,r.kt)("inlineCode",{parentName:"p"},"init()")," is unavoidable or desirable, code should attempt to:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Be completely deterministic, regardless of program environment or invocation."),(0,r.kt)("li",{parentName:"ol"},"Avoid depending on the ordering or side-effects of other ",(0,r.kt)("inlineCode",{parentName:"li"},"init()")," functions. While the ",(0,r.kt)("inlineCode",{parentName:"li"},"init()")," order is well-known, code can change, and thus relationships between ",(0,r.kt)("inlineCode",{parentName:"li"},"init()")," functions can make code brittle and error-prone."),(0,r.kt)("li",{parentName:"ol"},"Avoid accessing or manipulating global or environment states, such as machine information, environment variables, working directory, program arguments/inputs, etc."),(0,r.kt)("li",{parentName:"ol"},"Avoid I/O, including filesystem, network, and system calls.")),(0,r.kt)("p",null,"Code that cannot satisfy these requirements likely belongs as a helper to be called as part of ",(0,r.kt)("inlineCode",{parentName:"p"},"main()")," (or elsewhere in a program's lifecycle), or be written as part of ",(0,r.kt)("inlineCode",{parentName:"p"},"main()"),' itself. In particular, libraries intended to be used by other programs should take special care to be completely deterministic and not perform "init magic".'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type Foo struct {\n    // ...\n}\n\nvar _defaultFoo Foo\n\nfunc init() {\n    _defaultFoo = Foo{\n        // ...\n    }\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'type Config struct {\n    // ...\n}\n\nvar _config Config\n\nfunc init() {\n    // Bad: based on current directory\n    cwd, _ := os.Getwd()\n\n    // Bad: I/O\n    raw, _ := os.ReadFile(\n        path.Join(cwd, "config", "config.yaml"),\n    )\n\n    yaml.Unmarshal(raw, &_config)\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"var _defaultFoo = Foo{\n    // ...\n}\n\n// or, better, for testability:\n\nvar _defaultFoo = defaultFoo()\n\nfunc defaultFoo() Foo {\n    return Foo{\n        // ...\n    }\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'type Config struct {\n    // ...\n}\n\nfunc loadConfig() Config {\n    cwd, err := os.Getwd()\n    // handle err\n\n    raw, err := os.ReadFile(\n        path.Join(cwd, "config", "config.yaml"),\n    )\n    // handle err\n\n    var config Config\n    yaml.Unmarshal(raw, &config)\n\n    return config\n}\n')),(0,r.kt)("p",null,"Considering the above, some situations in which ",(0,r.kt)("inlineCode",{parentName:"p"},"init()")," may be preferable or necessary might include:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Complex expressions that cannot be represented as single assignments.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Pluggable hooks, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"database/sql")," dialects, encoding type registries, etc.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Optimizations to ",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations"},"Google Cloud Functions")," and other forms of deterministic precomputation."))),(0,r.kt)("h2",{id:"performance"},"Performance"),(0,r.kt)("p",null,"Performance-specific guidelines apply only to the hot path."),(0,r.kt)("h4",{id:"prefer-strconv-over-fmt"},"Prefer strconv over fmt"),(0,r.kt)("p",null,"When converting primitives to/from strings, ",(0,r.kt)("inlineCode",{parentName:"p"},"strconv")," is faster than ",(0,r.kt)("inlineCode",{parentName:"p"},"fmt"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"for i := 0; i < b.N; i++ {\n  s := fmt.Sprint(rand.Int())\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BenchmarkFmtSprint-4    143 ns/op    2 allocs/op\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"for i := 0; i < b.N; i++ {\n  s := strconv.Itoa(rand.Int())\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BenchmarkStrconv-4    64.2 ns/op    1 allocs/op\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},'avoid use "+" for string concatenation')),(0,r.kt)("h4",{id:"avoid-string-to-byte-conversion"},"Avoid string-to-byte conversion"),(0,r.kt)("p",null,"Do not create byte slices from a fixed string repeatedly. Instead, perform the conversion once and capture the result."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'for i := 0; i < b.N; i++ {\n  w.Write([]byte("Hello world"))\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BenchmarkBad-4   50000000   22.2 ns/op\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'data := []byte("Hello world")\nfor i := 0; i < b.N; i++ {\n  w.Write(data)\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BenchmarkGood-4  500000000   3.25 ns/op\n")),(0,r.kt)("h4",{id:"prefer-specifying-container-capacity"},"Prefer Specifying Container Capacity"),(0,r.kt)("p",null,"Specify container capacity where possible to allocate memory for the container up front. This minimizes subsequent allocations (copying and resizing the container) as elements are added."),(0,r.kt)("h5",{id:"specifying-map-capacity-hints"},"Specifying Map Capacity Hints"),(0,r.kt)("p",null,"Provide capacity hints when initializing maps with ",(0,r.kt)("inlineCode",{parentName:"p"},"make()")," where possible."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"make(map[T1]T2, hint)\n")),(0,r.kt)("p",null,"Providing a capacity hint to ",(0,r.kt)("inlineCode",{parentName:"p"},"make()")," tries to right-size the map at initialization time, which reduces the need for growing the map and allocations as elements are added to the map."),(0,r.kt)("p",null,"Unlike slices, map capacity hints do not guarantee complete, preemptive allocation but are used to approximate the number of hashmap buckets required. Consequently, allocations may still occur when adding elements to the map, even up to the specified capacity."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'m := make(map[string]os.FileInfo)\n\nfiles, _ := os.ReadDir("./files")\nfor _, f := range files {\n    m[f.Name()] = f\n}\n')),(0,r.kt)("p",null,"`m' is created without a size hint; there may be more allocations at assignment time."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'\nfiles, _ := os.ReadDir("./files")\n\nm := make(map[string]os.DirEntry, len(files))\nfor _, f := range files {\n    m[f.Name()] = f\n}\n')),(0,r.kt)("p",null,"`m' is created with a size hint; there may be fewer allocations at assignment time."),(0,r.kt)("h5",{id:"specifying-slice-capacity"},"Specifying Slice Capacity"),(0,r.kt)("p",null,"Where possible, provide capacity hints when initializing slices with ",(0,r.kt)("inlineCode",{parentName:"p"},"make()"),", particularly when appending."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"make([]T, length, capacity)\n")),(0,r.kt)("p",null,"Unlike maps, slice capacity is not a hint: the compiler will allocate enough memory for the capacity of the slice as provided to ",(0,r.kt)("inlineCode",{parentName:"p"},"make()"),", which means that subsequent ",(0,r.kt)("inlineCode",{parentName:"p"},"append()")," operations will incur zero allocations (until the length of the slice matches the capacity, after which any appends will require a resize to hold additional elements)."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"for n := 0; n < b.N; n++ {\n  data := make([]int, 0)\n  for k := 0; k < size; k++{\n    data = append(data, k)\n  }\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BenchmarkBad-4    100000000    2.48s\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"for n := 0; n < b.N; n++ {\n  data := make([]int, 0, size)\n  for k := 0; k < size; k++{\n    data = append(data, k)\n  }\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"BenchmarkGood-4   100000000    0.21s\n")),(0,r.kt)("h3",{id:"function-grouping-and-ordering"},"Function Grouping and Ordering"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Functions should be sorted in rough call order."),(0,r.kt)("li",{parentName:"ul"},"The receiver should group functions in a file.")),(0,r.kt)("p",null,"Therefore, exported functions should appear first in a file, after ",(0,r.kt)("inlineCode",{parentName:"p"},"struct"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"const"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"var")," definitions."),(0,r.kt)("p",null,"A ",(0,r.kt)("inlineCode",{parentName:"p"},"newXYZ()"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"NewXYZ()")," may appear after the type is defined but before the rest of the methods on the receiver."),(0,r.kt)("p",null,"Since the receiver groups functions, plain utility functions should appear toward the end of the file."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (s *something) Cost() {\n  return calcCost(s.weights)\n}\n\ntype something struct{ ... }\n\nfunc calcCost(n []int) int {...}\n\nfunc (s *something) Stop() {...}\n\nfunc newSomething() *something {\n    return &something{}\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type something struct{ ... }\n\nfunc newSomething() *something {\n    return &something{}\n}\n\nfunc (s *something) Cost() {\n  return calcCost(s.weights)\n}\n\nfunc (s *something) Stop() {...}\n\nfunc calcCost(n []int) int {...}\n")),(0,r.kt)("h3",{id:"reduce-nesting"},"Reduce Nesting"),(0,r.kt)("p",null,"Code should reduce nesting where possible by handling error cases/special conditions first and returning early or continuing the loop. Reduce the amount of code that is nested on multiple levels."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'for _, v := range data {\n  if v.F1 == 1 {\n    v = process(v)\n    if err := v.Call(); err == nil {\n      v.Send()\n    } else {\n      return err\n    }\n  } else {\n    log.Printf("Invalid v: %v", v)\n  }\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'for _, v := range data {\n  if v.F1 != 1 {\n    log.Printf("Invalid v: %v", v)\n    continue\n  }\n\n  v = process(v)\n  if err := v.Call(); err != nil {\n    return err\n  }\n  v.Send()\n}\n')),(0,r.kt)("h3",{id:"writing-tests"},"Writing Tests"),(0,r.kt)("p",null,"Use table-driven tests with ",(0,r.kt)("a",{parentName:"p",href:"https://blog.golang.org/subtests"},"subtests")," to avoid duplicating code when the core\ntest logic is repetitive."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Bad:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// func TestSplitHostPort(t *testing.T)\n\nhost, port, err := net.SplitHostPort("192.0.2.0:8000")\nrequire.NoError(t, err)\nassert.Equal(t, "192.0.2.0", host)\nassert.Equal(t, "8000", port)\n\nhost, port, err = net.SplitHostPort("192.0.2.0:http")\nrequire.NoError(t, err)\nassert.Equal(t, "192.0.2.0", host)\nassert.Equal(t, "http", port)\n\nhost, port, err = net.SplitHostPort(":8000")\nrequire.NoError(t, err)\nassert.Equal(t, "", host)\nassert.Equal(t, "8000", port)\n\nhost, port, err = net.SplitHostPort("1:8")\nrequire.NoError(t, err)\nassert.Equal(t, "1", host)\nassert.Equal(t, "8", port)\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// func TestSplitHostPort(t *testing.T)\n\ntests := []struct{\n  give     string\n  wantHost string\n  wantPort string\n}{\n  {\n    give:     "192.0.2.0:8000",\n    wantHost: "192.0.2.0",\n    wantPort: "8000",\n  },\n  {\n    give:     "192.0.2.0:http",\n    wantHost: "192.0.2.0",\n    wantPort: "http",\n  },\n  {\n    give:     ":8000",\n    wantHost: "",\n    wantPort: "8000",\n  },\n  {\n    give:     "1:8",\n    wantHost: "1",\n    wantPort: "8",\n  },\n}\n\nfor _, tt := range tests {\n  t.Run(tt.give, func(t *testing.T) {\n    host, port, err := net.SplitHostPort(tt.give)\n    require.NoError(t, err)\n    assert.Equal(t, tt.wantHost, host)\n    assert.Equal(t, tt.wantPort, port)\n  })\n}\n')),(0,r.kt)("p",null,"Test tables make it easier to add context to error messages, reduce duplicate logic, and add new test cases."),(0,r.kt)("p",null,"We follow the convention that the slice of structs is referred to as ",(0,r.kt)("inlineCode",{parentName:"p"},"tests")," and each test case ",(0,r.kt)("inlineCode",{parentName:"p"},"tt"),". Further, we encourage explicating the input and output  values for each test case with ",(0,r.kt)("inlineCode",{parentName:"p"},"give")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"want")," prefixes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"tests := []struct{\n  give     string\n  wantHost string\n  wantPort string\n}{\n  // ...\n}\n\nfor _, tt := range tests {\n  // ...\n}\n")),(0,r.kt)("p",null,"Parallel tests, like some specialized loops (for example, those that spawn goroutines or capture references as part of the loop body), must take care to explicitly assign loop variables within the loop's scope to ensure that they hold the expected values."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"tests := []struct{\n  give string\n  // ...\n}{\n  // ...\n}\n\nfor _, tt := range tests {\n  tt := tt // for t.Parallel\n  t.Run(tt.give, func(t *testing.T) {\n    t.Parallel()\n    // ...\n  })\n}\n")),(0,r.kt)("p",null,"In the example above, we must declare a ",(0,r.kt)("inlineCode",{parentName:"p"},"tt")," variable scoped to the loop iteration because of the use of ",(0,r.kt)("inlineCode",{parentName:"p"},"t.Parallel()")," below. If we do not do that, most or all tests will receive an unexpected value for ",(0,r.kt)("inlineCode",{parentName:"p"},"tt")," or a value that changes as they run."),(0,r.kt)("h4",{id:"use-subtests"},"Use Subtests"),(0,r.kt)("p",null,"Always use subtest beside you are using or not table drive tests. This can reduce the scope of the tests and be more transparent and easy to maintain. Each small case of the tests should be a new subtest."),(0,r.kt)("h3",{id:"avoid-writing-directly-in-the-stdout"},"Avoid writing directly in the stdout"),(0,r.kt)("p",null,"Avoid writing logs directly to the stdout or stderr. Use a proper log package for it.\nIt's also easier to maintain. We don't need to find all prints and change the code if we need to change."),(0,r.kt)("h3",{id:"avoid-panic"},"Avoid panic"),(0,r.kt)("p",null,"Avoid panic in simple and small methods; all errors should be handled on the top level and application, and we can decide if we will panic or not.\nWe can also create a proper panic recovery to close all states, open connection from the application, and graceful exit without breaking anything."))}d.isMDXComponent=!0}}]);